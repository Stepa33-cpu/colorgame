<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Game</title>
    <style>
        #color-grid {
            display: grid;
            grid-template-columns: repeat(5, 100px);
            grid-gap: 0px;
            margin-top: 20px;
        }
        .color-box {
            width: 100px;
            height: 100px;
            border: none;
            cursor: pointer;
        }
        #user-info {
            display: none;
        }
    </style>
    <script>
        let selectedButtons = [];
        let colorMatrix = [];
        let level = 1;
        let startTime = 0;
        let userInfo = {};

        // Function to show user info form
        function showUserInfo() {
            document.getElementById('user-info').style.display = 'block';
        }

        // Function to start the game
        async function startGame() {
            showUserInfo();
        }

        // Function to collect user info
        function saveUserInfo() {
            userInfo.name = document.getElementById('name').value;
            userInfo.surname = document.getElementById('surname').value;
            userInfo.age = document.getElementById('age').value;
            userInfo.gender = document.querySelector('input[name="gender"]:checked').value;

            document.getElementById('user-info').style.display = 'none';
            startLevel();
        }

        // Start a new level
        async function startLevel() {
            const response = await fetch('/start_level', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ level }),
            });

            const data = await response.json();
            colorMatrix = data.color_matrix;
            displayColorMatrix(colorMatrix);
            startTime = performance.now(); // Start timer for this level
        }

        // Display color matrix
        function displayColorMatrix(matrix) {
            const colorGrid = document.getElementById('color-grid');
            colorGrid.innerHTML = ''; // Clear previous colors
            selectedButtons = [];

            matrix.forEach(row => {
                row.forEach(color => {
                    const colorBox = document.createElement('div');
                    colorBox.className = 'color-box';
                    colorBox.style.backgroundColor = color; // Set the background color
                    colorBox.onclick = () => toggleSelection(colorBox, color);
                    colorGrid.appendChild(colorBox);
                });
            });

            // Clear previous button section
            const buttonContainer = document.getElementById('button-container');
            buttonContainer.innerHTML = ''; // Clear previous buttons

            // Add a button for "All Colors are the Same"
            const sameColorButton = document.createElement('button');
            sameColorButton.innerText = "All Colors are the Same";
            sameColorButton.onclick = () => submitAnswer("allSame");
            buttonContainer.appendChild(sameColorButton);

            // Add an input for the number of color groups
            const colorGroupsInput = document.createElement('input');
            colorGroupsInput.type = 'number';
            colorGroupsInput.id = 'colorGroups';
            colorGroupsInput.placeholder = 'I see ___ color groups';
            colorGroupsInput.min = 1;
            colorGroupsInput.max = 10; // Set max limit to 10
            buttonContainer.appendChild(colorGroupsInput);

            // Next button
            const nextButton = document.createElement('button');
            nextButton.innerText = "Next";
            nextButton.onclick = () => submitAnswer("next");
            buttonContainer.appendChild(nextButton);
        }

        // Toggle button selection
        function toggleSelection(colorBox, color) {
            if (selectedButtons.includes(colorBox)) {
                selectedButtons = selectedButtons.filter(btn => btn !== colorBox);
                colorBox.style.boxShadow = "none"; // Reset border
            } else {
                selectedButtons.push(colorBox);
                colorBox.style.boxShadow = "inset 0 0 0 5px red"; // Highlight selected
            }
        }

        // Submit the answer
        async function submitAnswer(action) {
            const endTime = performance.now();
            const timeSpent = (endTime - startTime) / 1000; // Convert to seconds

            // Collect selected colors
            const selectedColors = selectedButtons.map(btn => btn.style.backgroundColor);
            const answer = action === "allSame" ? "All Colors are the Same" : `Selected Colors: ${selectedColors.join(', ')}`;
            const colorGroups = document.getElementById('colorGroups').value; // Get color groups input
            level++;

            try {
                const response = await fetch('/submit_answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_info: userInfo,
                        level: level - 1, // Level before incrementing
                        time_spent: timeSpent,
                        answer,
                        color_matrix: colorMatrix,
                        color_groups: colorGroups // Include color groups in the request
                    }),
                });

                // Check if response is ok
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                alert(data.message);
                if (level <= 10) {
                    startLevel(); // Proceed to next level
                } else {
                    alert('Game over! Thank you for playing.');
                }
            } catch (error) {
                console.error('Error submitting answer:', error);
                alert('An error occurred: ' + error.message);
            }
        }
    </script>
</head>
<body onload="startGame()">
    <h1>Color Game</h1>
    <div id="user-info">
        <input type="text" id="name" placeholder="Name" required>
        <input type="text" id="surname" placeholder="Surname" required>
        <input type="number" id="age" placeholder="Age" required>
        <div>
            <label><input type="radio" name="gender" value="Male" required> Male</label>
            <label><input type="radio" name="gender" value="Female" required> Female</label>
            <label><input type="radio" name="gender" value="Other" required> Other</label>
        </div>
        <button onclick="saveUserInfo()">Start Game</button>
    </div>
    <div id="color-grid"></div>
    <div id="button-container"></div>
</body>
</html>
